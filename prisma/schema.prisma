// AURION Research Labs - Prisma Schema
// This schema mirrors the init-db.sql structure

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions", "multiSchema"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  schemas    = ["aurion", "public"]
  extensions = [pgvector(map: "vector", schema: "public"), uuid_ossp(map: "uuid-ossp", schema: "public"), pg_trgm(schema: "public")]
}

model Organization {
  id        String   @id @default(uuid()) @db.Uuid
  name      String   @db.VarChar(255)
  slug      String   @unique @db.VarChar(100)
  plan      String   @default("free") @db.VarChar(50)
  settings  Json     @default("{}")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  workspaces  Workspace[]
  memberships Membership[]
  auditLogs   AuditLog[]

  @@map("organizations")
  @@schema("aurion")
}

model Workspace {
  id             String   @id @default(uuid()) @db.Uuid
  organizationId String   @map("org_id") @db.Uuid
  name           String   @db.VarChar(255)
  vertical       String   @db.VarChar(50) // electroai, photonai, bioai
  config         Json     @default("{}")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  jobs         Job[]
  datasets     Dataset[]
  models       Model[]

  @@map("workspaces")
  @@schema("aurion")
}

model User {
  id           String   @id @default(uuid()) @db.Uuid
  email        String   @unique @db.VarChar(255)
  passwordHash String   @map("password_hash") @db.VarChar(255)
  firstName    String?  @map("first_name") @db.VarChar(100)
  lastName     String?  @map("last_name") @db.VarChar(100)
  avatarUrl    String?  @map("avatar_url") @db.VarChar(500)
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  memberships Membership[]
  jobs        Job[]
  auditLogs   AuditLog[]

  @@map("users")
  @@schema("aurion")
}

model Membership {
  id             String   @id @default(uuid()) @db.Uuid
  userId         String   @map("user_id") @db.Uuid
  organizationId String   @map("org_id") @db.Uuid
  role           String   @default("member") @db.VarChar(50) // owner, admin, member, viewer
  createdAt      DateTime @default(now()) @map("created_at")

  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([userId, organizationId])
  @@map("memberships")
  @@schema("aurion")
}

model Job {
  id          String   @id @default(uuid()) @db.Uuid
  workspaceId String   @map("workspace_id") @db.Uuid
  userId      String   @map("user_id") @db.Uuid
  type        String   @db.VarChar(100)
  status      String   @default("pending") @db.VarChar(50) // pending, running, completed, failed, cancelled
  priority    Int      @default(5)
  payload     Json     @default("{}")
  result      Json?
  errorMsg    String?  @map("error_msg")
  startedAt   DateTime? @map("started_at")
  completedAt DateTime? @map("completed_at")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  results   Result[]

  @@index([workspaceId, status])
  @@index([userId])
  @@map("jobs")
  @@schema("aurion")
}

model Dataset {
  id          String   @id @default(uuid()) @db.Uuid
  workspaceId String   @map("workspace_id") @db.Uuid
  name        String   @db.VarChar(255)
  description String?
  type        String   @db.VarChar(100)
  s3Uri       String   @map("s3_uri") @db.VarChar(500)
  sizeBytes   BigInt?  @map("size_bytes")
  metadata    Json     @default("{}")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@index([workspaceId])
  @@map("datasets")
  @@schema("aurion")
}

model Model {
  id          String   @id @default(uuid()) @db.Uuid
  workspaceId String   @map("workspace_id") @db.Uuid
  name        String   @db.VarChar(255)
  version     String   @db.VarChar(50)
  framework   String   @db.VarChar(100)
  artifactUri String   @map("artifact_uri") @db.VarChar(500)
  metrics     Json     @default("{}")
  status      String   @default("registered") @db.VarChar(50) // registered, deployed, archived
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  workspace Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)

  @@unique([workspaceId, name, version])
  @@map("models")
  @@schema("aurion")
}

model Result {
  id        String   @id @default(uuid()) @db.Uuid
  jobId     String   @map("job_id") @db.Uuid
  type      String   @db.VarChar(100)
  data      Json     @default("{}")
  s3Uri     String?  @map("s3_uri") @db.VarChar(500)
  createdAt DateTime @default(now()) @map("created_at")

  job Job @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId])
  @@map("results")
  @@schema("aurion")
}

model AuditLog {
  id             String   @id @default(uuid()) @db.Uuid
  organizationId String   @map("org_id") @db.Uuid
  userId         String?  @map("user_id") @db.Uuid
  action         String   @db.VarChar(100)
  resourceType   String   @map("resource_type") @db.VarChar(100)
  resourceId     String?  @map("resource_id") @db.Uuid
  metadata       Json     @default("{}")
  ipAddress      String?  @map("ip_address") @db.VarChar(45)
  createdAt      DateTime @default(now()) @map("created_at")

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User?        @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([organizationId, createdAt])
  @@map("audit_logs")
  @@schema("aurion")
}
